<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Purrtfolio | Welcome</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: "Poppins", sans-serif;
    }

    body {
      min-height: 100vh;
      background: linear-gradient(135deg, #fce3ec, #ffe7c7);
      padding: 2rem;
      color: #333;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
      background: #fff;
      padding: 1.5rem;
      border-radius: 15px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .header h1 {
      font-size: 1.8rem;
      color: #222;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .username {
      font-size: 1rem;
      color: #555;
      font-weight: 500;
    }

    .logout-btn {
      background: #ff6b9d;
      color: #fff;
      border: none;
      padding: 0.6rem 1.2rem;
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 600;
    }

    .logout-btn:hover {
      background: #ff4757;
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
    }

    .portfolio-section {
      background: #fff;
      padding: 2rem;
      border-radius: 15px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      margin-bottom: 2rem;
    }

    .portfolio-section h2 {
      font-size: 1.5rem;
      color: #222;
      margin-bottom: 1.5rem;
      border-bottom: 2px solid #ffb3c1;
      padding-bottom: 0.5rem;
    }

    .portfolio-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }

    .portfolio-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .stat-card {
      background: linear-gradient(135deg, #ffb3c1, #ffc9d4);
      padding: 1.2rem;
      border-radius: 10px;
      color: #fff;
      text-align: center;
    }

    .stat-card h3 {
      font-size: 0.9rem;
      font-weight: 400;
      margin-bottom: 0.5rem;
      opacity: 0.9;
    }

    .stat-card .value {
      font-size: 1.8rem;
      font-weight: 700;
    }

    .holdings-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 2rem;
    }

    .holdings-table thead {
      background: #f8f9fa;
      border-bottom: 2px solid #ffb3c1;
    }

    .holdings-table th {
      padding: 1rem;
      text-align: left;
      font-weight: 600;
      color: #333;
    }

    .holdings-table td {
      padding: 1rem;
      border-bottom: 1px solid #eee;
    }

    .holdings-table tbody tr:hover {
      background: #fef9f3;
    }

    .empty-message {
      text-align: center;
      padding: 2rem;
      color: #999;
      font-size: 1.1rem;
    }

    .buy-stocks-btn {
      background: #ffb3c1;
      color: #fff;
      border: none;
      padding: 0.8rem 2rem;
      border-radius: 25px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 600;
      font-size: 1rem;
    }

    .buy-stocks-btn:hover {
      background: #ff94a2;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .action-section {
      display: flex;
      gap: 1rem;
      justify-content: center;
    }

    .loading {
      text-align: center;
      padding: 2rem;
      color: #999;
    }

    .error {
      background: #ffe5e5;
      color: #d32f2f;
      padding: 1rem;
      border-radius: 10px;
      margin-bottom: 1rem;
      border-left: 4px solid #d32f2f;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Purrtfolio Welcome üêæ</h1>
      <div class="user-info">
        <span class="username" id="usernameDisplay"></span>
        <button class="logout-btn" onclick="logout()">Logout</button>
      </div>
    </div>

    <div class="portfolio-section">
      <h2>Your Portfolio</h2>

      <div id="errorMessage"></div>

      <div id="loadingMessage" class="loading">Loading your portfolio...</div>

      <div id="portfolioContent" style="display: none;">
        <div class="portfolio-stats">
          <div class="stat-card">
            <h3>Total Holdings</h3>
            <div class="value" id="holdingsCount">0</div>
          </div>
          <div class="stat-card">
            <h3>Portfolio Value</h3>
            <div class="value" id="portfolioValue">$0.00</div>
          </div>
        </div>

        <div id="holdingsTableContainer">
          <table class="holdings-table">
            <thead>
              <tr>
                <th>Company</th>
                <th>Symbol</th>
                <th>Quantity</th>
                <th>Price per Share</th>
                <th>Total Value</th>
              </tr>
            </thead>
            <tbody id="holdingsTableBody">
            </tbody>
          </table>
        </div>

        <div id="emptyPortfolioMessage" class="empty-message" style="display: none;">
          Your portfolio is empty. Start buying stocks to build your portfolio!
        </div>

        <div class="action-section">
          <button class="buy-stocks-btn" onclick="goToBuyStocks()">
            üìà Buy Stocks
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const username = localStorage.getItem("username");
      if (!username) {
        window.location.href = "/login.html";
        return;
      }

      document.getElementById("usernameDisplay").textContent = `Hello, ${username}!`;
      loadPortfolio();
    });

    async function loadPortfolio() {
      try {
        const response = await fetch("/api/portfolio", {
          method: "GET",
          headers: { "Content-Type": "application/json" },
        });

        if (response.status === 401) {
          window.location.href = "/login.html";
          return;
        }

        if (!response.ok) {
          throw new Error("Failed to load portfolio");
        }

        const data = await response.json();
        displayPortfolio(data);
      } catch (error) {
        console.error("Error loading portfolio:", error);
        document.getElementById("loadingMessage").style.display = "none";
        document.getElementById("errorMessage").innerHTML =
          '<div class="error">Error loading portfolio: ' + error.message + "</div>";
      }
    }

    function displayPortfolio(data) {
      const holdings = data.holdings || [];
      const totalValue = (data.totalValue || 0).toFixed(2);

      document.getElementById("loadingMessage").style.display = "none";
      document.getElementById("portfolioContent").style.display = "block";

      // Update stats
      document.getElementById("holdingsCount").textContent = holdings.length;
      document.getElementById("portfolioValue").textContent = `$${totalValue}`;

      // Display holdings table
      const tableBody = document.getElementById("holdingsTableBody");
      tableBody.innerHTML = "";

      if (holdings.length === 0) {
        document.getElementById("holdingsTableContainer").style.display = "none";
        document.getElementById("emptyPortfolioMessage").style.display = "block";
      } else {
        document.getElementById("holdingsTableContainer").style.display = "block";
        document.getElementById("emptyPortfolioMessage").style.display = "none";

        holdings.forEach((stock) => {
          const quantity = stock.quantity || 1;
          const pricePerShare = parseFloat(stock.price).toFixed(2);
          const totalValue = (parseFloat(stock.price) * quantity).toFixed(2);
          
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${stock.name}</td>
            <td><strong>${stock.symbol}</strong></td>
            <td>${quantity}</td>
            <td>$${pricePerShare}</td>
            <td>$${totalValue}</td>
          `;
          tableBody.appendChild(row);
        });
      }
    }

    function goToBuyStocks() {
      window.location.href = "/buy-stocks.html";
    }

    function logout() {
      localStorage.removeItem("username");
      localStorage.removeItem("token");
      window.location.href = "/logout";
    }
  </script>
</body>
</html>
